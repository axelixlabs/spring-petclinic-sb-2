name: Build and Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  repository_dispatch:
    types: [ monorepo-backend-updated ]

jobs:
  build-source:
    runs-on: ubuntu-latest
    env:
      # Since this path is used in multiple places, itâ€™s better to store it in a separate variable.
      SPRING_PET_CLINIC: spring-petclinic:2.7.18-SNAPSHOT
      # Variables and credentials for downloading dependencies from Nexus
      NEXUS_USER: ${{ secrets.NEXUS_USER }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      NEXUS_HOST_PORT: ${{ secrets.NEXUS_HOST_PORT }}
      STORE_PASS: ${{ secrets.STORE_PASS }}
      # Variables to access k8s
      DOCKER_CR_OAUTH_TOKEN: ${{ secrets.DOCKER_CR_OAUTH_TOKEN }}
      CR_URL: ${{ vars.CR_URL }}
      CR_REPOSITORY: ${{ vars.CR_REPOSITORY }}
      KUBE_CONFIG_BASE64: ${{ secrets.KUBE_CONFIG_BASE64 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'liberica'
          java-version: '17'
          cache: maven

      - name: Download and trust Nexus SSL certificate
        run: |
            openssl s_client -connect $NEXUS_HOST_PORT -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > nexus.crt
            sudo keytool -importcert -file nexus.crt -alias nexus-ssl -keystore $JAVA_HOME/lib/security/cacerts -storepass $STORE_PASS -noprompt

      - name: Build with Maven
        run: |
          mvn -B -s settings.xml clean package

      - name: Set up Docker
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        uses: docker/setup-docker-action@v4

      - name: Build Docker Image
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        run: |
          docker build --tag $CR_URL/$CR_REPOSITORY/$SPRING_PET_CLINIC --file docker/Dockerfile .

      - name: Docker login to Yandex Cloud CR
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        run: echo $DOCKER_CR_OAUTH_TOKEN | docker login --username oauth --password-stdin $CR_URL

      - name: Docker push to Yandex Cloud CR
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        run: docker push $CR_URL/$CR_REPOSITORY/$SPRING_PET_CLINIC

      - name: Docker logout
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        run: docker logout

      - name: Setup Helm
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.14.0

      - name: Deploy spring-petclinic to K8S
        if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch'}}
        working-directory: chart
        run: |
          mkdir -p ~/.kube
          touch ~/.kube/config
          echo "$KUBE_CONFIG_BASE64" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          helm upgrade --install petclinic . --set image.ref=$CR_URL/$CR_REPOSITORY/$SPRING_PET_CLINIC -f values.yaml
